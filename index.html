<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S&P 500 Bubble Chart (Cached)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #fafafa;
    }
    #chartContainer {
      width: 100%;
      max-width: 900px;
      margin: auto;
    }
  </style>
</head>
<body>
  <h2>S&P 500 Bubble Chart (Last 7 Days, Cached)</h2>
  <p>Данные загружаются один раз, затем читаются из кеша (IndexedDB).</p>

  <div id="chartContainer">
    <canvas id="bubbleChart"></canvas>
  </div>

    <div id="debugInfo" style="max-width:900px;margin:auto;margin-top:20px;padding:10px;background:#fff0f0;border:1px solid #e0c0c0;color:#a00;font-size:14px;display:none"></div>

  <script>
    /************** IndexedDB Wrapper **************/
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("sp500DB", 1);

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains("prices")) {
            db.createObjectStore("prices", { keyPath: "date" });
          }
        };

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function saveToDB(key, data) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction("prices", "readwrite");
        tx.objectStore("prices").put({ date: key, data });
        tx.oncomplete = resolve;
        tx.onerror = reject;
      });
    }

    async function loadFromDB(key) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction("prices", "readonly");
        const req = tx.objectStore("prices").get(key);
        req.onsuccess = () => resolve(req.result ? req.result.data : null);
        req.onerror = reject;
      });
    }

    /************** Data Loading **************/
    async function fetchSp500Data(date) {
        const debug = document.getElementById('debugInfo');
        const cached = await loadFromDB(date);
        if (cached) {
          debug.style.display = 'block';
          debug.innerText += `\n[${date}] Loaded from cache.`;
          console.log("Loaded from cache", date);
          return cached;
        }

        debug.style.display = 'block';
        debug.innerText += `\n[${date}] Downloading fresh...`;
        // Convert date to UNIX timestamps for Yahoo API
        const d = new Date(date);
        const period1 = Math.floor(d.setHours(0,0,0,0)/1000);
        const period2 = Math.floor(d.setHours(23,59,59,999)/1000);
        const url = `https://query1.finance.yahoo.com/v7/finance/download/%5EGSPC?period1=${period1}&period2=${period2}&interval=1d&events=history`;

        let text = '';
        try {
          const response = await fetch(url);
          if (!response.ok) {
            debug.innerText += `\n[${date}] Fetch error: ${response.status} ${response.statusText}`;
            return '';
          }
          text = await response.text();
        } catch (err) {
          debug.innerText += `\n[${date}] Network error: ${err}`;
          return '';
        }

        await saveToDB(date, text);
        return text;
    }

    function csvToPrice(csv) {
        if (!csv || typeof csv !== 'string') return null;
        const lines = csv.trim().split("\n");
        if (lines.length < 2) return null;
        // Find first non-header line with valid price
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(",");
          if (cols.length > 4 && !isNaN(parseFloat(cols[4]))) {
            return parseFloat(cols[4]); // Close price
          }
        }
        return null;
    }

    async function loadLast7Days() {
        const today = new Date();
        const result = [];
        const debug = document.getElementById('debugInfo');
        debug.innerText = '';
        debug.style.display = 'none';

        for (let i = 0; i < 7; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const iso = d.toISOString().split("T")[0];

          const csv = await fetchSp500Data(iso);
          const price = csvToPrice(csv);
          if (price) {
            result.push({ date: iso, price });
            debug.innerText += `\n[${iso}] Price: ${price}`;
          } else {
            debug.innerText += `\n[${iso}] No price data.`;
          }
        }

        debug.style.display = 'block';
        return result.reverse();
    }

    /************** Chart Rendering **************/
    function renderChart(data) {
      const ctx = document.getElementById("bubbleChart");

      const chartData = data.map((p, i) => ({
        x: i,
        y: p.price,
        r: 8
      }));

      new Chart(ctx, {
        type: "bubble",
        data: {
          datasets: [
            {
              label: "S&P 500 (last 7 days)",
              data: chartData,
              backgroundColor: "rgba(54, 162, 235, 0.6)",
            },
          ],
        },
        options: {
          scales: {
            x: { title: { display: true, text: "Day index" } },
            y: { title: { display: true, text: "Price" } },
          },
        },
      });
    }

    /************** Bootstrap **************/
    (async function () {
      const data = await loadLast7Days();
      renderChart(data);
    })();
  </script>
</body>
</html>
